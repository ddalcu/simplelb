<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleLB - Dashboard</title>
    
    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/style.css">
    
    <style>
        /* Dashboard-specific styles */

        /* Load Balancer Table */
        .lb-list {
            padding: 0;
        }

        .search-filter {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(90deg, var(--bg-secondary) 0%, #202020 100%);
            position: relative;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            transition: all 0.2s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(139 92 246 / 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .lb-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .lb-table th {
            background: var(--bg-secondary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .lb-table th:hover {
            background: var(--bg-hover);
        }

        .lb-table th.sortable::after {
            content: '\f0dc';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .lb-table th.sort-asc::after {
            content: '\f0de';
            color: var(--primary);
        }

        .lb-table th.sort-desc::after {
            content: '\f0dd';
            color: var(--primary);
        }

        .lb-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .lb-table tbody tr {
            transition: background-color 0.2s;
        }

        .lb-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .domain-cell {
            font-weight: 600;
            color: var(--text-primary);
            max-width: 300px;
        }

        .domain-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
        }

        .domain-item {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }


        .method-cell {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .backends-cell {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .backend-count {
            font-weight: 600;
            color: var(--primary);
        }

        .backend-list {
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .cert-domain {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: 1rem;
        }


        .cert-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }

        .cert-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            min-width: auto;
        }

        .cert-request-btn {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .cert-request-btn:hover {
            background: #7c3aed;
            border-color: #7c3aed;
        }

        .cert-request-btn:disabled {
            background: var(--bg-secondary);
            color: var(--text-muted);
            border-color: var(--border);
            cursor: not-allowed;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .actions-cell .btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .btn-success {
            background: #16a34a;
            color: white;
            border: 1px solid #16a34a;
        }

        .btn-success:hover {
            background: #15803d;
            border-color: #15803d;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            border: 1px solid #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
            border-color: #d97706;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-card);
            margin: 2rem auto;
            border-radius: var(--radius);
            width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }


        /* Dashboard-specific form overrides */

        .ssl-notice {
            background: var(--bg-tertiary);
            border: 1px solid var(--info);
            border-radius: var(--radius);
            padding: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
        }

        /* Toggle switch for auto-scroll */
        .toggle-switch {
            width: 50px;
            height: 24px;
            background-color: var(--border);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
        }

        .toggle-switch.active {
            background-color: var(--primary);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        /* HTTPS Redirect Control */
        .https-redirect-control {
            display: flex;
            align-items: center;
            margin-right: 1rem;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .toggle-text {
            font-weight: 500;
            white-space: nowrap;
        }

        .https-redirect-control .toggle-switch {
            width: 44px;
            height: 22px;
        }

        .https-redirect-control .toggle-slider {
            width: 18px;
            height: 18px;
        }

        .https-redirect-control .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }

        .https-redirect-control .toggle-switch.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Deployment toggle row */
        .deployment-toggle-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .deployment-toggle-row .toggle-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        .deployment-toggle-row .toggle-switch {
            width: 40px;
            height: 20px;
        }
        .deployment-toggle-row .toggle-slider {
            width: 16px;
            height: 16px;
        }
        .deployment-toggle-row .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }
        .deployment-toggle-row .toggle-switch.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard-specific responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: auto;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .https-redirect-control {
                margin-right: 0.5rem;
            }

            .toggle-text {
                font-size: 0.8rem;
            }

            .header-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .https-redirect-control {
                order: -1;
                width: 100%;
                justify-content: center;
                margin: 0 0 0.5rem 0;
                padding: 0.5rem;
                background: var(--bg-secondary);
                border-radius: var(--radius);
            }
        }

            /* Table responsive adjustments */
            .lb-table {
                font-size: 0.8rem;
            }
            
            .lb-table th,
            .lb-table td {
                padding: 0.75rem 0.5rem;
            }
            
            .domain-cell {
                max-width: 150px;
            }
            
            .backend-list {
                max-width: 100px;
                white-space: nowrap;
            }
            
            .actions-cell .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
                margin-right: 0.25rem;
            }
            
            /* Stack table on very small screens */
            @media (max-width: 480px) {
                .lb-table,
                .lb-table thead,
                .lb-table tbody,
                .lb-table th,
                .lb-table td,
                .lb-table tr {
                    display: block;
                }
                
                .lb-table thead tr {
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                }
                
                .lb-table tr {
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    margin-bottom: 1rem;
                    padding: 1rem;
                    background: var(--bg-card);
                }
                
                .lb-table td {
                    border: none;
                    position: relative;
                    padding: 0.5rem 0;
                }
                
                .lb-table td:before {
                    content: attr(data-label) ": ";
                    font-weight: bold;
                    color: var(--text-secondary);
                }
                
                
                .actions-cell {
                    text-align: center;
                    margin-top: 1rem;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-brand">
                <h1>SimpleLB</h1>
                <p class="header-tagline">Simple Load Balancer ‚Ä¢ Secure & Scalable</p>
                <div id="caddy-status" style="margin-top: 0.5rem; font-size: 0.85rem;">
                    <span id="status-indicator" style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px;"></span>
                    <span id="status-text">Checking...</span>
                </div>
            </div>
            <div class="header-actions">
                <button onclick="openConfigViewerModal()" class="btn btn-outline">
                    <i class="fas fa-eye"></i> View Config
                </button>
                <button onclick="openLogsModal()" class="btn btn-outline">
                    <i class="fas fa-file-alt"></i> Logs
                </button>
                <a href="/logout" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <!-- Managed Mode Warning -->
        {{if .isManaged}}
        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: 1px solid #f59e0b; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="font-size: 1.25rem;">
                    <i class="fas fa-lock"></i>
                </div>
                <div>
                    <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                        Configuration Management Mode: MANAGED
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        This load balancer configuration is managed through environment variables. 
                        To make changes, update your docker-compose.yml and restart the container.
                    </div>
                </div>
            </div>
        </div>
        {{end}}

        <!-- Main Content -->
        <div class="main-card">
            <div class="card-header">
                <h2 class="card-title">Load Balancers</h2>
                {{if .isManaged}}
                <button class="btn btn-primary" disabled title="Configuration is managed via environment variables">
                    <i class="fas fa-lock"></i> Managed Configuration
                </button>
                {{else}}
                <button onclick="openAddModal()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Load Balancer
                </button>
                {{end}}
            </div>
            
            <div class="lb-list">
                {{if .loadBalancers}}
                    <div class="search-filter">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search domains, methods, or backends..." onkeyup="filterTable()">
                        <i class="fas fa-search" style="position: absolute; right: 3rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>
                    </div>
                    
                    <table class="lb-table" id="lbTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable(0)">Domain(s)</th>
                                <th class="sortable" onclick="sortTable(1)">Method</th>
                                <th class="sortable" onclick="sortTable(2)">Backends</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .loadBalancers}}
                            <tr data-domain="{{.domain}}">
                                <td class="domain-cell" data-label="Domains">
                                    <div class="domain-list">
                                        {{if .domains}}
                                            {{range .domains}}
                                                <span class="domain-item">{{.}}</span>
                                            {{end}}
                                        {{else}}
                                            <span class="domain-item">{{.domain}}</span>
                                        {{end}}
                                    </div>
                                </td>
                                
                                <td class="method-cell" data-label="Method">
                                    {{if eq .method "random"}}Random{{end}}
                                    {{if eq .method "round_robin"}}Round Robin{{end}}
                                    {{if eq .method "least_conn"}}Least Connections{{end}}
                                    {{if eq .method "first"}}First Available{{end}}
                                    {{if eq .method "ip_hash"}}IP Hash{{end}}
                                    {{if eq .method "header"}}Header Hash{{end}}
                                    {{if eq .method "cookie"}}Cookie Hash{{end}}
                                </td>
                                
                                <td class="backends-cell" data-label="Backends">
                                    <div class="backend-count">{{len .backends}} servers</div>
                                    <div class="backend-list" title="{{range $index, $backend := .backends}}{{if $index}}, {{end}}{{$backend}}{{end}}">
                                        {{range $index, $backend := .backends}}
                                            {{if $index}}, {{end}}{{$backend}}
                                        {{end}}
                                    </div>
                                </td>
                                
                                <td class="actions-cell" data-label="Actions">
                                    {{if $.isManaged}}
                                    <button class="btn btn-outline" disabled title="Configuration is managed via environment variables">
                                        <i class="fas fa-lock"></i> View Only
                                    </button>
                                    {{else}}
                                    <div class="deployment-toggle-row">
                                        <span class="toggle-label">Deploy:</span>
                                        <div class="toggle-switch {{if .caddy_deployed}}active{{end}}" id="deployToggle-{{.name}}" onclick="toggleLoadBalancerDeployment('{{.name}}', {{.caddy_deployed}})" title="{{if .caddy_deployed}}Deployed to Caddy{{else}}Not deployed{{end}}">
                                            <div class="toggle-slider"></div>
                                        </div>
                                    </div>
                                    <button onclick="editLB('{{.name}}')" class="btn btn-outline">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="deleteLB('{{.name}}')" class="btn btn-danger">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    {{end}}
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                {{else}}
                    <div class="empty-state" style="padding: 4rem 2rem;">
                        <div class="empty-icon">
                            <i class="fas fa-balance-scale" style="font-size: 4rem; opacity: 0.3;"></i>
                        </div>
                        <h3 class="empty-title">No Load Balancers</h3>
                        <p>Get started by adding your first load balancer with automatic HTTPS</p>
                    </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="lbModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Load Balancer</h3>
                <button class="modal-close" onclick="closeLBModal()">&times;</button>
            </div>
            <form id="lbForm" method="post" action="/add">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Domain Name(s)</label>
                        <input type="text" name="domain" id="domainInput" class="form-input" 
                               placeholder="example.com, api.example.com, www.example.com" required>
                        <div class="form-help">Single domain or comma-separated domains (e.g., api.company.com, www.company.com)</div>
                    </div>
                    
                    <div class="form-group">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Backend Servers</label>
                        <textarea name="backends" id="upstreamsInput" class="form-textarea" 
                                  placeholder="192.168.1.100:8080&#10;192.168.1.101:8080&#10;app-server-03:3000" required></textarea>
                        <div class="form-help">One server per line. Format: hostname:port or ip:port</div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Load Balancing Method</label>
                            <select name="method" id="methodSelect" class="form-select" onchange="toggleHashOptions()">
                                <option value="random">Random (Default)</option>
                                <option value="round_robin">Round Robin</option>
                                <option value="least_conn">Least Connections</option>
                                <option value="first">First Available</option>
                                <option value="ip_hash">IP Hash</option>
                                <option value="header">Header Hash</option>
                                <option value="cookie">Cookie Hash</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Hash Key</label>
                            <select name="hash_key" id="hashKeySelect" class="form-select" disabled>
                                <option value="">Not applicable</option>
                                <option value="X-Forwarded-For">X-Forwarded-For Header</option>
                                <option value="X-Real-IP">X-Real-IP Header</option>
                                <option value="X-User-ID">X-User-ID Header</option>
                                <option value="Authorization">Authorization Header</option>
                                <option value="session_id">session_id Cookie</option>
                                <option value="user_session">user_session Cookie</option>
                            </select>
                            <div class="form-help">Select hash key for header/cookie-based load balancing</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" onclick="closeLBModal()" class="btn btn-outline">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" id="submitBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Load Balancer
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Config Viewer Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Configuration Viewer</h3>
                <button class="modal-close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button onclick="exportConfig()" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-download"></i> Download Caddyfile
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; text-align: center;">
                        View current configuration in Caddyfile format
                    </p>
                </div>
                
                <div id="exportSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Current Configuration (Caddyfile)</label>
                        <textarea id="exportedConfig" class="form-textarea" readonly 
                                  style="height: 300px; font-family: ui-monospace, monospace; font-size: 0.8rem;"></textarea>
                        <div class="form-help">Copy this Caddyfile to save or share your current setup</div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="copyToClipboard()" class="btn btn-outline">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button onclick="downloadConfig()" class="btn btn-outline">
                            <i class="fas fa-download"></i> Download Caddyfile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" class="modal">
        <div class="modal-content" style="width: 90vw; max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title" id="logsModalTitle">Application Logs</h3>
                <button class="modal-close" onclick="closeLogsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
                        <select class="form-select" id="logTypeSelect" onchange="switchLogType(this.value)" style="width: auto; min-width: 200px;">
                            <option value="app">Application Logs</option>
                            <option value="caddy">Caddy Access Logs</option>
                            <option value="caddy-error">Caddy Error Logs</option>
                        </select>
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                            <span>Auto-scroll:</span>
                            <div class="toggle-switch" id="autoScrollToggle" onclick="toggleAutoScroll()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <button onclick="refreshLogs()" class="btn btn-outline">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button onclick="clearLogs(currentLogType)" class="btn btn-outline" style="color: #ef4444;">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 1rem; border-radius: var(--radius); font-size: 0.9rem; color: var(--text-secondary);">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                            <i class="fas fa-info-circle"></i> Log Information
                        </div>
                        Showing the last 1000 lines. Logs are updated when you click refresh or switch log types.
                    </div>
                </div>
                
                <div id="logContainer" style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; font-family: ui-monospace, monospace; font-size: 0.8rem; line-height: 1.4; color: var(--text-secondary); white-space: pre-wrap; overflow-x: auto; max-height: 40vh; overflow-y: auto;">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let isManaged = {{.isManaged}};

        function openAddModal() {
            if (isManaged) {
                alert('‚ö†Ô∏è Configuration is managed via environment variables. Editing is disabled.');
                return;
            }
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'Add Load Balancer';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-plus"></i> Add Load Balancer';
            document.getElementById('lbForm').action = '/add';
            document.getElementById('lbForm').reset();
            document.getElementById('lbModal').style.display = 'block';
            toggleHashOptions();
        }


        function editLB(name) {
            if (isManaged) {
                alert('‚ö†Ô∏è Configuration is managed via environment variables. Editing is disabled.');
                return;
            }
            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'Edit Load Balancer';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Save Changes';
            document.getElementById('lbForm').action = '/edit/' + encodeURIComponent(name);
            
            // Fetch load balancer data
            fetch('/edit/' + encodeURIComponent(name))
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch load balancer data');
                    }
                    return response.json();
                })
                .then(data => {
                    // Populate form fields
                    document.getElementById('domainInput').value = data.domain || '';
                    
                    document.getElementById('methodSelect').value = data.method || 'random';
                    document.getElementById('hashKeySelect').value = data.hash_key || '';
                    document.getElementById('upstreamsInput').value = data.backends || '';
                    
                    // Show hash fields based on selections
                    toggleHashOptions();
                    
                    // Show modal
                    document.getElementById('lbModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading load balancer:', error);
                    alert('‚ùå Error loading load balancer data: ' + error.message);
                });
        }

        function closeLBModal() {
            document.getElementById('lbModal').style.display = 'none';
        }

// SSL fields removed; automatic HTTPS is global

        function toggleHashOptions() {
            const method = document.getElementById('methodSelect').value;
            const hashKeySelect = document.getElementById('hashKeySelect');
            
            if (method === 'header' || method === 'cookie') {
                hashKeySelect.disabled = false;
                hashKeySelect.required = true;
            } else {
                hashKeySelect.disabled = true;
                hashKeySelect.required = false;
                hashKeySelect.value = '';
            }
        }

        function deleteLB(name) {
            if (isManaged) {
                alert('‚ö†Ô∏è Configuration is managed via environment variables. Editing is disabled.');
                return;
            }
            if (confirm('‚ö†Ô∏è Are you sure you want to delete the load balancer "' + name + '"?\n\nThis action cannot be undone.')) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = 'üóëÔ∏è Deleting...';
                button.disabled = true;
                
                // Use fetch to submit delete request
                fetch('/delete/' + encodeURIComponent(name), {
                    method: 'POST'
                })
                .then(response => {
                    if (response.redirected) {
                        // Successful deletion, redirect to dashboard
                        window.location.href = response.url;
                    } else if (!response.ok) {
                        throw new Error('Delete request failed');
                    }
                })
                .catch(error => {
                    console.error('Error deleting load balancer:', error);
                    alert('‚ùå Error deleting load balancer: ' + error.message);
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            }
        }


        function toggleLoadBalancerDeployment(name, currentlyDeployed) {
            if (isManaged) {
                alert('‚ö†Ô∏è Configuration is managed via environment variables. Deployment changes are disabled.');
                return;
            }
            
            const toggle = document.getElementById(`deployToggle-${name}`);
            const newState = !currentlyDeployed;
            
            // Temporarily disable the toggle
            toggle.classList.add('disabled');
            
            fetch(`/api/loadbalancers/${encodeURIComponent(name)}/toggle-deployment`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ deployed: newState })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Toggle deployment failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Update toggle state
                if (data.deployed) {
                    toggle.classList.add('active');
                    toggle.setAttribute('title', 'Deployed to Caddy');
                } else {
                    toggle.classList.remove('active');
                    toggle.setAttribute('title', 'Not deployed');
                }
                
                // Update the onclick handler to reflect new state
                toggle.setAttribute('onclick', `toggleLoadBalancerDeployment('${name}', ${data.deployed})`);
                
                // Show success message
                const message = data.deployed 
                    ? `Load balancer "${name}" deployed to Caddy`
                    : `Load balancer "${name}" removed from Caddy`;
                showSuccessMessage(message);
            })
            .catch(error => {
                console.error('Error toggling deployment:', error);
                alert('‚ùå Error toggling deployment: ' + error.message);
            })
            .finally(() => {
                toggle.classList.remove('disabled');
            });
        }



        // Config Viewer functions
        function openConfigViewerModal() {
            document.getElementById('configModal').style.display = 'block';
            exportConfig(); // Automatically load the config
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            showMainSection();
        }

        function showMainSection() {
            document.getElementById('exportSection').style.display = 'none';
        }

        function exportConfig() {
            document.getElementById('exportSection').style.display = 'block';
            
            // Fetch current configuration
            fetch('/export')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to export configuration');
                    }
                    return response.text();
                })
                .then(config => {
                    document.getElementById('exportedConfig').value = config;
                })
                .catch(error => {
                    console.error('Error exporting config:', error);
                    document.getElementById('exportedConfig').value = 'Error loading configuration: ' + error.message;
                });
        }


        function copyToClipboard() {
            const configText = document.getElementById('exportedConfig');
            configText.select();
            configText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(configText.value).then(function() {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }).catch(function(err) {
                alert('Failed to copy to clipboard: ' + err);
            });
        }

        function downloadConfig() {
            const config = document.getElementById('exportedConfig').value;
            const blob = new Blob([config], { type: 'text/caddyfile' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Caddyfile-' + new Date().toISOString().slice(0, 10);
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Table sorting functionality
        let currentSort = { column: -1, direction: 'asc' };

        function sortTable(columnIndex) {
            const table = document.getElementById('lbTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            // Toggle direction if same column clicked
            if (currentSort.column === columnIndex) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.direction = 'asc';
            }
            currentSort.column = columnIndex;
            
            // Update header indicators
            const headers = table.getElementsByTagName('th');
            for (let i = 0; i < headers.length; i++) {
                headers[i].className = headers[i].className.replace(' sort-asc', '').replace(' sort-desc', '');
                if (headers[i].classList.contains('sortable')) {
                    if (i === columnIndex) {
                        headers[i].classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                // For backends column, sort by number (now column 4)
                if (columnIndex === 4) {
                    const aNum = parseInt(aText.match(/\d+/)[0]);
                    const bNum = parseInt(bText.match(/\d+/)[0]);
                    return currentSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Text comparison for other columns
                const comparison = aText.localeCompare(bText);
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
            
            // Reappend sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Search/filter functionality
        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('lbTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) { // Skip header row
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let shouldShow = false;
                
                // Search through all cells
                for (let j = 0; j < cells.length - 1; j++) { // Skip actions column
                    const cellText = cells[j].textContent.toLowerCase();
                    if (cellText.includes(filter)) {
                        shouldShow = true;
                        break;
                    }
                }
                
                row.style.display = shouldShow ? '' : 'none';
            }
        }

        // Logs modal functions
        let autoScroll = true;
        let currentLogType = 'app';

        function openLogsModal() {
            document.getElementById('logsModal').style.display = 'block';
            document.getElementById('logTypeSelect').value = 'app';
            currentLogType = 'app';
            loadLogs('app');
            // Initialize auto-scroll as active
            document.getElementById('autoScrollToggle').classList.add('active');
        }

        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
        }

        function switchLogType(logType) {
            currentLogType = logType;
            loadLogs(logType);
        }

        function checkCaddyStatus() {
            fetch('/api/caddy/status')
                .then(response => response.json())
                .then(data => {
                    const indicator = document.getElementById('status-indicator');
                    const text = document.getElementById('status-text');
                    
                    if (data.running) {
                        indicator.style.backgroundColor = '#10b981';
                        text.textContent = 'Caddy Running';
                    } else {
                        indicator.style.backgroundColor = '#ef4444';
                        text.textContent = 'Caddy Not Responding';
                    }
                })
                .catch(error => {
                    const indicator = document.getElementById('status-indicator');
                    const text = document.getElementById('status-text');
                    indicator.style.backgroundColor = '#f59e0b';
                    text.textContent = 'Status Unknown';
                });
        }

        function clearLogs(logType) {
            if (!confirm(`Are you sure you want to clear ${logType} logs?`)) {
                return;
            }
            
            fetch(`/api/logs?type=${logType}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || 'Logs cleared');
                    loadLogs(logType); // Reload the logs
                })
                .catch(error => {
                    alert('Failed to clear logs: ' + error.message);
                });
        }

        function loadLogs(logType) {
            const logContainer = document.getElementById('logContainer');
            const modalTitle = document.getElementById('logsModalTitle');
            
            logContainer.textContent = 'Loading logs...';
            
            fetch(`/api/logs?type=${logType}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch logs');
                    }
                    return response.json();
                })
                .then(data => {
                    modalTitle.textContent = data.logName;
                    logContainer.textContent = data.logs;
                    if (autoScroll) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    logContainer.textContent = 'Error loading logs: ' + error.message;
                });
        }

        function refreshLogs() {
            loadLogs(currentLogType);
        }

        function toggleAutoScroll() {
            const toggle = document.getElementById('autoScrollToggle');
            autoScroll = !autoScroll;
            
            if (autoScroll) {
                toggle.classList.add('active');
                const container = document.getElementById('logContainer');
                container.scrollTop = container.scrollHeight;
            } else {
                toggle.classList.remove('active');
            }
        }

        // Modals can only be closed via buttons (no click outside to dismiss)


        function loadHTTPSRedirectSettings() {
            fetch('/api/https-redirect')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch HTTPS redirect settings');
                    }
                    return response.json();
                })
                .then(data => {
                    httpsRedirectEnabled = data.enabled;
                    updateHTTPSRedirectToggle();
                })
                .catch(error => {
                    console.error('Error loading HTTPS redirect settings:', error);
                });
        }

        function updateHTTPSRedirectToggle() {
            const toggle = document.getElementById('httpsRedirectToggle');
            if (httpsRedirectEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            // Disable toggle in managed mode
            if (isManaged) {
                toggle.classList.add('disabled');
                toggle.onclick = () => {
                    alert('‚ö†Ô∏è Configuration is managed via environment variables. HTTPS redirect settings cannot be changed.');
                };
            }
        }

        function toggleHTTPSRedirect() {
            if (isManaged) {
                alert('‚ö†Ô∏è Configuration is managed via environment variables. HTTPS redirect settings cannot be changed.');
                return;
            }

            const toggle = document.getElementById('httpsRedirectToggle');
            const newState = !httpsRedirectEnabled;
            
            // Temporarily disable the toggle
            toggle.classList.add('disabled');
            
            fetch('/api/https-redirect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled: newState })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update HTTPS redirect setting');
                }
                return response.json();
            })
            .then(data => {
                httpsRedirectEnabled = newState;
                updateHTTPSRedirectToggle();
                
                // Show success message
                const message = newState ? 'HTTPS redirects enabled' : 'HTTPS redirects disabled';
                showSuccessMessage(message);
            })
            .catch(error => {
                console.error('Error updating HTTPS redirect:', error);
                alert('‚ùå Error updating HTTPS redirect: ' + error.message);
            })
            .finally(() => {
                toggle.classList.remove('disabled');
            });
        }

        function showSuccessMessage(message) {
            // Create a temporary success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #16a34a;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1001;
                font-size: 0.9rem;
                font-weight: 500;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }


        // Load HTTPS redirect settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check Caddy status immediately and then every 2 seconds
            checkCaddyStatus();
            setInterval(checkCaddyStatus, 2000);
        });

        // Simple form validation
        document.getElementById('lbForm').addEventListener('submit', function(e) {
            const backends = document.getElementById('upstreamsInput').value.trim();
            const domains = document.getElementById('domainInput').value.trim();
            
            if (!backends) {
                e.preventDefault();
                alert('‚ö†Ô∏è Please add at least one backend server');
                return;
            }
            
            // Validate domain format
            if (domains) {
                const domainList = domains.split(',').map(d => d.trim()).filter(d => d);
                for (let domain of domainList) {
                    if (!domain.includes('.')) {
                        e.preventDefault();
                        alert('‚ö†Ô∏è Invalid domain format: ' + domain + '\nEach domain must contain at least one dot (e.g., example.com)');
                        return;
                    }
                }
            }
        });
    </script>
</body>
</html>